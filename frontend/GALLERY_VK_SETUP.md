# Настройка галереи с загрузкой фото из VK

## Текущее состояние

Галерея настроена и работает с локальными фотографиями из `/public/images/gallery/`. Реализована пагинация с автоматическим определением количества загружаемых фото:
- **Мобильные устройства** (< 768px): +10 фото при нажатии "Показать больше"
- **Desktop** (≥ 768px): +20 фото при нажатии "Показать больше"

## Переход на загрузку из VK

Для подключения загрузки фотографий из альбома группы VK выполните следующие шаги:

---

### Шаг 1: Получение сервисного ключа доступа VK

1. Откройте настройки вашей группы ВКонтакте
2. Перейдите в раздел **"Управление" → "Настройки" → "Работа с API"**
3. Создайте новый ключ доступа:
   - Нажмите **"Создать ключ"**
   - Отметьте права доступа: **"Фотографии"** (photos)
   - Скопируйте созданный ключ

**Важно:** Сервисный ключ доступа имеет вид длинной строки символов (например: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0`)

---

### Шаг 2: Получение ID группы

ID группы можно найти несколькими способами:

**Способ 1: Из адресной строки**
- URL группы: `https://vk.com/kamelot_club`
- Используйте короткое имя: `kamelot_club`
- Или числовой ID (если есть): `club123456789` → ID = `-123456789`

**Способ 2: Через настройки**
- Откройте группу → **"Управление"**
- В адресной строке найдите: `https://vk.com/club123456789?act=...`
- ID группы: `-123456789` (обратите внимание на **минус** в начале)

**Важно:** Для групп ID всегда отрицательный (начинается с минуса)

---

### Шаг 3: Получение ID альбома

1. Откройте группу ВКонтакте
2. Перейдите в раздел **"Фотографии"**
3. Выберите нужный альбом
4. Посмотрите URL в адресной строке:
   ```
   https://vk.com/album-123456789_987654321
   ```
   - `-123456789` — ID группы
   - `987654321` — ID альбома (это то, что нужно)

**Альтернатива:** Можно использовать системные альбомы:
- `wall` — фотографии со стены
- `profile` — фотографии профиля
- `saved` — сохраненные фотографии

---

### Шаг 4: Настройка переменных окружения

1. Создайте файл `.env` в корне проекта (если его нет):
   ```bash
   cp .env.example .env
   ```

2. Откройте `.env` и заполните переменные VK:

   ```env
   # VK API Configuration for Gallery
   NUXT_VK_ACCESS_TOKEN=ваш_сервисный_ключ_доступа
   NUXT_VK_GROUP_ID=-123456789
   NUXT_VK_ALBUM_ID=987654321
   ```

**Пример реальных значений:**
```env
NUXT_VK_ACCESS_TOKEN=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0
NUXT_VK_GROUP_ID=-123456789
NUXT_VK_ALBUM_ID=wall
```

---

### Шаг 5: Перезапуск приложения

После настройки переменных окружения перезапустите приложение:

```bash
# Остановите текущий процесс (Ctrl+C)

# Запустите заново
npm run dev
```

**Приложение автоматически переключится на загрузку фото из VK!**

---

## Проверка работы

После запуска откройте главную страницу и проверьте:

1. **В консоли браузера** (F12 → Console) не должно быть ошибок
2. **В консоли сервера** вы увидите одно из сообщений:
   - `[VK Photos API] VK API не настроен, используем локальные фото` — если ключи не настроены
   - Отсутствие сообщения = успешная загрузка из VK
3. **Кнопка "Показать больше"** должна подгружать новые фото

---

## Отладка проблем

### Ошибка: "Invalid access_token"
- Проверьте правильность сервисного ключа
- Убедитесь, что ключ не содержит лишних пробелов
- Проверьте права доступа ключа (должны быть включены "Фотографии")

### Ошибка: "Album not found"
- Проверьте правильность ID альбома
- Убедитесь, что альбом существует и не удален
- Проверьте настройки приватности альбома (должен быть доступен)

### Ошибка: "Access denied"
- Проверьте ID группы (должен начинаться с минуса)
- Убедитесь, что группа существует
- Проверьте настройки приватности группы

### Фото не загружаются
1. Откройте DevTools → Network
2. Найдите запрос к `/api/vk-photos`
3. Посмотрите ответ сервера:
   - `source: "vk"` — фото загружаются из VK ✓
   - `source: "local"` — используются локальные фото (VK недоступен)

---

## Возврат к локальным фото

Если нужно временно вернуться к локальным фото:

1. **Способ 1:** Удалите или закомментируйте переменные VK в `.env`:
   ```env
   # NUXT_VK_ACCESS_TOKEN=...
   # NUXT_VK_GROUP_ID=...
   # NUXT_VK_ALBUM_ID=...
   ```

2. **Способ 2:** Верните заглушки:
   ```env
   NUXT_VK_ACCESS_TOKEN=your_vk_access_token_here
   NUXT_VK_GROUP_ID=your_vk_group_id_here
   NUXT_VK_ALBUM_ID=your_vk_album_id_here
   ```

3. Перезапустите приложение

---

## Архитектура решения

### Файлы, которые были изменены/созданы:

1. **`.env.example`** — шаблон переменных окружения
2. **`nuxt.config.ts`** — добавлены VK переменные в runtimeConfig
3. **`server/api/vk-photos.get.ts`** — API endpoint для загрузки фото из VK
4. **`composables/useGallery.ts`** — добавлена логика пагинации
5. **`pages/index.vue`** — обновлена для работы с новой логикой
6. **`components/Gallery.vue`** — уже был готов к пагинации (не изменялся)

### Как это работает:

```
User клик "Показать больше"
         ↓
pages/index.vue → loadMore()
         ↓
composables/useGallery.ts → loadPhotosFromAPI()
         ↓
$fetch('/api/vk-photos?offset=X&count=Y')
         ↓
server/api/vk-photos.get.ts
         ↓
    VK API настроен?
    ├── ДА → fetch VK API → возврат фото
    └── НЕТ → возврат локальных фото
         ↓
Фото добавляются в галерею
```

### Особенности реализации:

- **Автоматический fallback**: если VK API недоступен, используются локальные фото
- **Адаптивность**: мобильные загружают 10 фото, desktop — 20
- **Кэширование**: можно добавить позже через Nitro Storage
- **Безопасность**: ключи доступа хранятся на сервере, не доступны клиенту
- **Максимальное качество**: загружаются фото в максимальном разрешении

---

## Дополнительные возможности

### Кэширование запросов (опционально)

Для уменьшения нагрузки на VK API можно добавить кэширование. Отредактируйте `server/api/vk-photos.get.ts`:

```typescript
import { useStorage } from '#nitro'

// В начале обработчика:
const cacheKey = `vk-photos-${offset}-${count}`
const storage = useStorage()

// Проверяем кэш
const cached = await storage.getItem(cacheKey)
if (cached) {
  return cached
}

// ... загрузка из VK ...

// Сохраняем в кэш на 1 час
await storage.setItem(cacheKey, result, { ttl: 3600 })
```

### Использование разных альбомов

Можно создать несколько галерей с разными альбомами:

```vue
<!-- pages/gallery-fights.vue -->
<Gallery
  :images="photos"
  :can-load-more="hasMore"
  :loading-more="loading"
  @load-more="handleLoadMore"
/>

<script setup>
// Загрузка из конкретного альбома
const loadPhotosFromAlbum = async (albumId) => {
  return await $fetch('/api/vk-photos', {
    query: { offset: 0, count: 20, album_id: albumId }
  })
}
</script>
```

---

## Полезные ссылки

- [VK API Documentation - photos.get](https://dev.vk.com/method/photos.get)
- [VK API - Работа с фотографиями](https://dev.vk.com/api/objects/photo)
- [Nuxt 3 - Runtime Config](https://nuxt.com/docs/guide/going-further/runtime-config)
- [Nitro Storage](https://nitro.unjs.io/guide/storage)

---

## Поддержка

При возникновении проблем:
1. Проверьте консоль браузера и сервера
2. Убедитесь, что все переменные окружения заполнены корректно
3. Проверьте права доступа VK API ключа
4. Проверьте настройки приватности группы и альбома

**Текущая версия:** 1.0
**Дата создания:** 2025-10-28
